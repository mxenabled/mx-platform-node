name: Generate Multi-Version SDK

on:
  workflow_dispatch:
    inputs:
      api_version:
        description: 'API Version to generate'
        required: true
        default: 'v20111101'
        type: choice
        options:
          - 'v20111101'
          - 'v20250224'
          - 'latest'
      version_level:
        description: "Bump version"
        required: true
        default: "patch"
        type: choice
        options:
        - major
        - minor
        - patch

jobs:
  Generate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: "20"
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1

    # Determine configuration based on API version
    - name: Set version configuration
      id: config
      run: |
        API_VERSION="${{ github.event.inputs.api_version }}"
        
        echo "config_file=./openapi/config-$API_VERSION.yml" >> $GITHUB_OUTPUT
        
        if [ "$API_VERSION" = "latest" ]; then
          echo "spec_url=https://raw.githubusercontent.com/mxenabled/openapi/master/openapi/v20111101.yml" >> $GITHUB_OUTPUT
          echo "output_dir=." >> $GITHUB_OUTPUT
        else
          echo "spec_url=https://raw.githubusercontent.com/mxenabled/openapi/master/openapi/$API_VERSION.yml" >> $GITHUB_OUTPUT
          echo "output_dir=./$API_VERSION" >> $GITHUB_OUTPUT
        fi
        
        echo "branch_suffix=-$API_VERSION" >> $GITHUB_OUTPUT

    - name: Bump version
      id: bump_version
      run: echo "version=$(ruby .github/version.rb ${{ github.event.inputs.version_level }} ${{ steps.config.outputs.config_file }})" >> $GITHUB_OUTPUT

    # Note: Do NOT clean repo for multi-version - we want to preserve existing version directories
    # The clean.rb script already protects version directories (v20111101, v20250224)

    - name: Install openapi-generator-cli
      run: |
        npm install @openapitools/openapi-generator-cli -g

    # Validate config file exists
    - name: Validate config file
      run: |
        if [ ! -f "${{ steps.config.outputs.config_file }}" ]; then
          echo "‚ùå Config file ${{ steps.config.outputs.config_file }} not found"
          echo "Available config files:"
          ls -la ./openapi/config*.yml || echo "No config files found"
          exit 1
        fi
        echo "‚úÖ Using config file: ${{ steps.config.outputs.config_file }}"

    - name: Generate SDK
      run: |
        echo "üîß Generating SDK for version: ${{ github.event.inputs.api_version }}"
        echo "üìÑ Config: ${{ steps.config.outputs.config_file }}"
        echo "üåê Spec: ${{ steps.config.outputs.spec_url }}"
        echo "üìÅ Output: ${{ steps.config.outputs.output_dir }}"
        
        openapi-generator-cli generate \
          -i ${{ steps.config.outputs.spec_url }} \
          -g typescript-axios \
          -c ${{ steps.config.outputs.config_file }} \
          -t ./openapi/templates \
          -o ${{ steps.config.outputs.output_dir }}

    # Test TypeScript compilation
    - name: Test TypeScript compilation
      run: |
        cd ${{ steps.config.outputs.output_dir }}
        npm install
        npm run build
        echo "‚úÖ TypeScript compilation successful"

    - name: Get package info
      id: package_info
      run: |
        PACKAGE_NAME=$(cat ${{ steps.config.outputs.output_dir }}/package.json | grep '"name"' | cut -d'"' -f4)
        echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT

    - name: Create branch
      run: git checkout -b "openapi-generator-${{ steps.bump_version.outputs.version }}${{ steps.config.outputs.branch_suffix }}"
    
    - name: Create commit
      run: |
        git config user.name "devexperience"
        git config user.email "devexperience@mx.com"
        git add .
        git commit -m "Generated version ${{ steps.bump_version.outputs.version }} (${{ github.event.inputs.api_version }})

        This pull request was automatically generated by a GitHub Action to generate version ${{ steps.bump_version.outputs.version }} of this library using API version ${{ github.event.inputs.api_version }}."
        git push -u origin "openapi-generator-${{ steps.bump_version.outputs.version }}${{ steps.config.outputs.branch_suffix }}"

    - name: Create PR
      run: |
        gh pr create \
          --title "Generated version ${{ steps.bump_version.outputs.version }} (${{ github.event.inputs.api_version }})" \
          --body "This pull request was automatically generated using API version **${{ github.event.inputs.api_version }}**.

        ## Generation Details
        - üìÑ **Config**: \`${{ steps.config.outputs.config_file }}\`
        - üåê **Spec**: \`${{ steps.config.outputs.spec_url }}\`
        - üî¢ **Version**: ${{ steps.bump_version.outputs.version }}
        - üì¶ **Package name**: ${{ steps.package_info.outputs.package_name }}
        - ‚úÖ **TypeScript compilation**: Passed

        ## Testing Notes
        This is a multi-version SDK generation for testing purposes. The generated package uses a version-specific name to avoid conflicts with the production package.

        Please review the generated changes before merging."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Slack notification
      uses: ravsamhq/notify-slack-action@v2
      if: always()
      with:
        status: ${{ job.status }}
        token: ${{ secrets.GITHUB_TOKEN }}
        notification_title: "{repo}: {workflow} workflow"
        message_format: "{emoji} *{workflow}* {status_message} in <{repo_url}|{repo}>"
        footer: "<{workflow_url}|View Workflow>"
        notify_when: "failure"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
