name: On Push to Master

on:
  push:
    branches: [master]
    paths:
      - 'v20111101/**'
      - 'v20250224/**'

jobs:
  # Check for skip-publish flag in commit message. This allows skipping publish/release for specific scenarios,
  # such as testing generated code, migrating files to new paths, etc.
  check-skip-publish:
    runs-on: ubuntu-latest
    outputs:
      skip_publish: ${{ steps.check.outputs.skip_publish }}
    steps:
      - name: Check for [skip-publish] flag in commit message
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" == *"[skip-publish]"* ]]; then
            echo "skip_publish=true" >> $GITHUB_OUTPUT
            echo "ðŸš« [skip-publish] flag detected - skipping all publish/release jobs"
          else
            echo "skip_publish=false" >> $GITHUB_OUTPUT
            echo "âœ… No skip flag - proceeding with publish/release"
          fi

  # Publish and release for each version conditionally
  # Only runs if [skip-publish] flag is NOT present AND files for that version were modified
  
  publish-v20111101:
    needs: check-skip-publish
    if: needs.check-skip-publish.outputs.skip_publish == 'false' && contains(github.event.head_commit.modified, 'v20111101')
    uses: ./.github/workflows/publish.yml@master
    with:
      version_directory: v20111101
    secrets: inherit

  release-v20111101:
    needs: [check-skip-publish, publish-v20111101]
    if: needs.check-skip-publish.outputs.skip_publish == 'false' && contains(github.event.head_commit.modified, 'v20111101')
    uses: ./.github/workflows/release.yml@master
    with:
      version_directory: v20111101
    secrets: inherit

  # Gate job to handle serial ordering when v20111101 is modified
  # Uses always() to run even if release-v20111101 is skipped, allowing downstream jobs to proceed
  # This ensures v20250224 can run when only v20250224 is modified, while still maintaining
  # serial ordering when both versions are modified
  gate-v20111101-complete:
    runs-on: ubuntu-latest
    needs: [check-skip-publish, release-v20111101]
    if: always() && needs.check-skip-publish.outputs.skip_publish == 'false'
    steps:
      - name: Gate complete - ready for v20250224
        run: echo "v20111101 release workflow complete (or skipped)"

  publish-v20250224:
    needs: [check-skip-publish, gate-v20111101-complete]
    if: needs.check-skip-publish.outputs.skip_publish == 'false' && contains(github.event.head_commit.modified, 'v20250224')
    uses: ./.github/workflows/publish.yml@master
    with:
      version_directory: v20250224
    secrets: inherit

  release-v20250224:
    needs: [check-skip-publish, publish-v20250224]
    if: needs.check-skip-publish.outputs.skip_publish == 'false' && contains(github.event.head_commit.modified, 'v20250224')
    uses: ./.github/workflows/release.yml@master
    with:
      version_directory: v20250224
    secrets: inherit
